
from kornia import create_meshgrid
import torch


def get_ray_directions(H, W, focal):
    """
    Get ray directions for all pixels in camera coordinate.
    Reference: https://www.scratchapixel.com/lessons/3d-basic-rendering/
               ray-tracing-generating-camera-rays/standard-coordinate-systems

    Inputs:
        H, W, focal: image height, width and focal length

    Outputs:
        directions: (H, W, 3), the direction of the rays in camera coordinate
    """
    grid = create_meshgrid(H, W, normalized_coordinates=False)[0]
    i, j = grid.unbind(-1)
    directions = \
        torch.stack([(i-W/2)/focal, -(j-H/2)/focal, -torch.ones_like(i)], -1) # (H, W, 3)

    return directions
#
# if __name__=="__main__":
#
#     output=get_ray_directions(10,10,10)
#     print(output)
#     """
#     tensor([[[-0.5000,  0.5000, -1.0000],
#          [-0.4000,  0.5000, -1.0000],
#          [-0.3000,  0.5000, -1.0000],
#          [-0.2000,  0.5000, -1.0000],
#          [-0.1000,  0.5000, -1.0000],
#          [ 0.0000,  0.5000, -1.0000],
#          [ 0.1000,  0.5000, -1.0000],
#          [ 0.2000,  0.5000, -1.0000],
#          [ 0.3000,  0.5000, -1.0000],
#          [ 0.4000,  0.5000, -1.0000]],
#
#         [[-0.5000,  0.4000, -1.0000],
#          [-0.4000,  0.4000, -1.0000],
#          [-0.3000,  0.4000, -1.0000],
#          [-0.2000,  0.4000, -1.0000],
#          [-0.1000,  0.4000, -1.0000],
#          [ 0.0000,  0.4000, -1.0000],
#          [ 0.1000,  0.4000, -1.0000],
#          [ 0.2000,  0.4000, -1.0000],
#          [ 0.3000,  0.4000, -1.0000],
#          [ 0.4000,  0.4000, -1.0000]],
#
#         [[-0.5000,  0.3000, -1.0000],
#          [-0.4000,  0.3000, -1.0000],
#          [-0.3000,  0.3000, -1.0000],
#          [-0.2000,  0.3000, -1.0000],
#          [-0.1000,  0.3000, -1.0000],
#          [ 0.0000,  0.3000, -1.0000],
#          [ 0.1000,  0.3000, -1.0000],
#          [ 0.2000,  0.3000, -1.0000],
#          [ 0.3000,  0.3000, -1.0000],
#          [ 0.4000,  0.3000, -1.0000]],
#
#         [[-0.5000,  0.2000, -1.0000],
#          [-0.4000,  0.2000, -1.0000],
#          [-0.3000,  0.2000, -1.0000],
#          [-0.2000,  0.2000, -1.0000],
#          [-0.1000,  0.2000, -1.0000],
#          [ 0.0000,  0.2000, -1.0000],
#          [ 0.1000,  0.2000, -1.0000],
#          [ 0.2000,  0.2000, -1.0000],
#          [ 0.3000,  0.2000, -1.0000],
#          [ 0.4000,  0.2000, -1.0000]],
#
#         [[-0.5000,  0.1000, -1.0000],
#          [-0.4000,  0.1000, -1.0000],
#          [-0.3000,  0.1000, -1.0000],
#          [-0.2000,  0.1000, -1.0000],
#          [-0.1000,  0.1000, -1.0000],
#          [ 0.0000,  0.1000, -1.0000],
#          [ 0.1000,  0.1000, -1.0000],
#          [ 0.2000,  0.1000, -1.0000],
#          [ 0.3000,  0.1000, -1.0000],
#          [ 0.4000,  0.1000, -1.0000]],
#
#         [[-0.5000, -0.0000, -1.0000],
#          [-0.4000, -0.0000, -1.0000],
#          [-0.3000, -0.0000, -1.0000],
#          [-0.2000, -0.0000, -1.0000],
#          [-0.1000, -0.0000, -1.0000],
#          [ 0.0000, -0.0000, -1.0000],
#          [ 0.1000, -0.0000, -1.0000],
#          [ 0.2000, -0.0000, -1.0000],
#          [ 0.3000, -0.0000, -1.0000],
#          [ 0.4000, -0.0000, -1.0000]],
#
#         [[-0.5000, -0.1000, -1.0000],
#          [-0.4000, -0.1000, -1.0000],
#          [-0.3000, -0.1000, -1.0000],
#          [-0.2000, -0.1000, -1.0000],
#          [-0.1000, -0.1000, -1.0000],
#          [ 0.0000, -0.1000, -1.0000],
#          [ 0.1000, -0.1000, -1.0000],
#          [ 0.2000, -0.1000, -1.0000],
#          [ 0.3000, -0.1000, -1.0000],
#          [ 0.4000, -0.1000, -1.0000]],
#
#         [[-0.5000, -0.2000, -1.0000],
#          [-0.4000, -0.2000, -1.0000],
#          [-0.3000, -0.2000, -1.0000],
#          [-0.2000, -0.2000, -1.0000],
#          [-0.1000, -0.2000, -1.0000],
#          [ 0.0000, -0.2000, -1.0000],
#          [ 0.1000, -0.2000, -1.0000],
#          [ 0.2000, -0.2000, -1.0000],
#          [ 0.3000, -0.2000, -1.0000],
#          [ 0.4000, -0.2000, -1.0000]],
#
#         [[-0.5000, -0.3000, -1.0000],
#          [-0.4000, -0.3000, -1.0000],
#          [-0.3000, -0.3000, -1.0000],
#          [-0.2000, -0.3000, -1.0000],
#          [-0.1000, -0.3000, -1.0000],
#          [ 0.0000, -0.3000, -1.0000],
#          [ 0.1000, -0.3000, -1.0000],
#          [ 0.2000, -0.3000, -1.0000],
#          [ 0.3000, -0.3000, -1.0000],
#          [ 0.4000, -0.3000, -1.0000]],
#
#         [[-0.5000, -0.4000, -1.0000],
#          [-0.4000, -0.4000, -1.0000],
#          [-0.3000, -0.4000, -1.0000],
#          [-0.2000, -0.4000, -1.0000],
#          [-0.1000, -0.4000, -1.0000],
#          [ 0.0000, -0.4000, -1.0000],
#          [ 0.1000, -0.4000, -1.0000],
#          [ 0.2000, -0.4000, -1.0000],
#          [ 0.3000, -0.4000, -1.0000],
#          [ 0.4000, -0.4000, -1.0000]]])
#     """