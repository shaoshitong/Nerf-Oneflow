import torch
import torch.nn as nn
class Embedding(nn.Module):
    def __init__(self, in_channels, N_freqs, logscale=True):
        """
        Defines a function that embeds x to (x, sin(2^k x), cos(2^k x), ...)
        in_channels: number of input channels (3 for both xyz and direction)
        """
        super(Embedding, self).__init__()
        self.N_freqs = N_freqs
        self.in_channels = in_channels
        self.funcs = [torch.sin, torch.cos]
        self.out_channels = in_channels*(len(self.funcs)*N_freqs+1)

        if logscale:
            self.freq_bands = 2**torch.linspace(0, N_freqs-1, N_freqs)
        else:
            self.freq_bands = torch.linspace(1, 2**(N_freqs-1), N_freqs)

    def forward(self, x):
        """
        Embeds x to (x, sin(2^k x), cos(2^k x), ...)
        Different from the paper, "x" is also in the output
        See https://github.com/bmild/nerf/issues/12

        Inputs:
            x: (B, self.in_channels)

        Outputs:
            out: (B, self.out_channels)
        """
        out = [x]
        for freq in self.freq_bands:
            for func in self.funcs:
                out += [func(freq*x)]

        return torch.cat(out, -1)

# model=Embedding(10,20)
# A=torch.ones(2,10)
# print(A,model(A))

"""
tensor([[1., 1., 1., 1., 1., 1., 1., 1., 1., 1.],
        [1., 1., 1., 1., 1., 1., 1., 1., 1., 1.]]) tensor([[ 1.0000,  1.0000,  1.0000,  1.0000,  1.0000,  1.0000,  1.0000,  1.0000,
          1.0000,  1.0000,  0.8415,  0.8415,  0.8415,  0.8415,  0.8415,  0.8415,
          0.8415,  0.8415,  0.8415,  0.8415,  0.5403,  0.5403,  0.5403,  0.5403,
          0.5403,  0.5403,  0.5403,  0.5403,  0.5403,  0.5403,  0.9093,  0.9093,
          0.9093,  0.9093,  0.9093,  0.9093,  0.9093,  0.9093,  0.9093,  0.9093,
         -0.4161, -0.4161, -0.4161, -0.4161, -0.4161, -0.4161, -0.4161, -0.4161,
         -0.4161, -0.4161, -0.7568, -0.7568, -0.7568, -0.7568, -0.7568, -0.7568,
         -0.7568, -0.7568, -0.7568, -0.7568, -0.6536, -0.6536, -0.6536, -0.6536,
         -0.6536, -0.6536, -0.6536, -0.6536, -0.6536, -0.6536,  0.9894,  0.9894,
          0.9894,  0.9894,  0.9894,  0.9894,  0.9894,  0.9894,  0.9894,  0.9894,
         -0.1455, -0.1455, -0.1455, -0.1455, -0.1455, -0.1455, -0.1455, -0.1455,
         -0.1455, -0.1455, -0.2879, -0.2879, -0.2879, -0.2879, -0.2879, -0.2879,
         -0.2879, -0.2879, -0.2879, -0.2879, -0.9577, -0.9577, -0.9577, -0.9577,
         -0.9577, -0.9577, -0.9577, -0.9577, -0.9577, -0.9577,  0.5514,  0.5514,
          0.5514,  0.5514,  0.5514,  0.5514,  0.5514,  0.5514,  0.5514,  0.5514,
          0.8342,  0.8342,  0.8342,  0.8342,  0.8342,  0.8342,  0.8342,  0.8342,
          0.8342,  0.8342,  0.9200,  0.9200,  0.9200,  0.9200,  0.9200,  0.9200,
          0.9200,  0.9200,  0.9200,  0.9200,  0.3919,  0.3919,  0.3919,  0.3919,
          0.3919,  0.3919,  0.3919,  0.3919,  0.3919,  0.3919,  0.7210,  0.7210,
          0.7210,  0.7210,  0.7210,  0.7210,  0.7210,  0.7210,  0.7210,  0.7210,
         -0.6929, -0.6929, -0.6929, -0.6929, -0.6929, -0.6929, -0.6929, -0.6929,
         -0.6929, -0.6929, -0.9992, -0.9992, -0.9992, -0.9992, -0.9992, -0.9992,
         -0.9992, -0.9992, -0.9992, -0.9992, -0.0398, -0.0398, -0.0398, -0.0398,
         -0.0398, -0.0398, -0.0398, -0.0398, -0.0398, -0.0398,  0.0795,  0.0795,
          0.0795,  0.0795,  0.0795,  0.0795,  0.0795,  0.0795,  0.0795,  0.0795,
         -0.9968, -0.9968, -0.9968, -0.9968, -0.9968, -0.9968, -0.9968, -0.9968,
         -0.9968, -0.9968, -0.1585, -0.1585, -0.1585, -0.1585, -0.1585, -0.1585,
         -0.1585, -0.1585, -0.1585, -0.1585,  0.9874,  0.9874,  0.9874,  0.9874,
          0.9874,  0.9874,  0.9874,  0.9874,  0.9874,  0.9874, -0.3131, -0.3131,
         -0.3131, -0.3131, -0.3131, -0.3131, -0.3131, -0.3131, -0.3131, -0.3131,
          0.9497,  0.9497,  0.9497,  0.9497,  0.9497,  0.9497,  0.9497,  0.9497,
          0.9497,  0.9497, -0.5946, -0.5946, -0.5946, -0.5946, -0.5946, -0.5946,
         -0.5946, -0.5946, -0.5946, -0.5946,  0.8040,  0.8040,  0.8040,  0.8040,
          0.8040,  0.8040,  0.8040,  0.8040,  0.8040,  0.8040, -0.9562, -0.9562,
         -0.9562, -0.9562, -0.9562, -0.9562, -0.9562, -0.9562, -0.9562, -0.9562,
          0.2928,  0.2928,  0.2928,  0.2928,  0.2928,  0.2928,  0.2928,  0.2928,
          0.2928,  0.2928, -0.5599, -0.5599, -0.5599, -0.5599, -0.5599, -0.5599,
         -0.5599, -0.5599, -0.5599, -0.5599, -0.8285, -0.8285, -0.8285, -0.8285,
         -0.8285, -0.8285, -0.8285, -0.8285, -0.8285, -0.8285,  0.9279,  0.9279,
          0.9279,  0.9279,  0.9279,  0.9279,  0.9279,  0.9279,  0.9279,  0.9279,
          0.3729,  0.3729,  0.3729,  0.3729,  0.3729,  0.3729,  0.3729,  0.3729,
          0.3729,  0.3729,  0.6921,  0.6921,  0.6921,  0.6921,  0.6921,  0.6921,
          0.6921,  0.6921,  0.6921,  0.6921, -0.7218, -0.7218, -0.7218, -0.7218,
         -0.7218, -0.7218, -0.7218, -0.7218, -0.7218, -0.7218, -0.9991, -0.9991,
         -0.9991, -0.9991, -0.9991, -0.9991, -0.9991, -0.9991, -0.9991, -0.9991,
          0.0421,  0.0421,  0.0421,  0.0421,  0.0421,  0.0421,  0.0421,  0.0421,
          0.0421,  0.0421, -0.0841, -0.0841, -0.0841, -0.0841, -0.0841, -0.0841,
         -0.0841, -0.0841, -0.0841, -0.0841, -0.9965, -0.9965, -0.9965, -0.9965,
         -0.9965, -0.9965, -0.9965, -0.9965, -0.9965, -0.9965,  0.1676,  0.1676,
          0.1676,  0.1676,  0.1676,  0.1676,  0.1676,  0.1676,  0.1676,  0.1676,
          0.9859,  0.9859,  0.9859,  0.9859,  0.9859,  0.9859,  0.9859,  0.9859,
          0.9859,  0.9859],
        [ 1.0000,  1.0000,  1.0000,  1.0000,  1.0000,  1.0000,  1.0000,  1.0000,
          1.0000,  1.0000,  0.8415,  0.8415,  0.8415,  0.8415,  0.8415,  0.8415,
          0.8415,  0.8415,  0.8415,  0.8415,  0.5403,  0.5403,  0.5403,  0.5403,
          0.5403,  0.5403,  0.5403,  0.5403,  0.5403,  0.5403,  0.9093,  0.9093,
          0.9093,  0.9093,  0.9093,  0.9093,  0.9093,  0.9093,  0.9093,  0.9093,
         -0.4161, -0.4161, -0.4161, -0.4161, -0.4161, -0.4161, -0.4161, -0.4161,
         -0.4161, -0.4161, -0.7568, -0.7568, -0.7568, -0.7568, -0.7568, -0.7568,
         -0.7568, -0.7568, -0.7568, -0.7568, -0.6536, -0.6536, -0.6536, -0.6536,
         -0.6536, -0.6536, -0.6536, -0.6536, -0.6536, -0.6536,  0.9894,  0.9894,
          0.9894,  0.9894,  0.9894,  0.9894,  0.9894,  0.9894,  0.9894,  0.9894,
         -0.1455, -0.1455, -0.1455, -0.1455, -0.1455, -0.1455, -0.1455, -0.1455,
         -0.1455, -0.1455, -0.2879, -0.2879, -0.2879, -0.2879, -0.2879, -0.2879,
         -0.2879, -0.2879, -0.2879, -0.2879, -0.9577, -0.9577, -0.9577, -0.9577,
         -0.9577, -0.9577, -0.9577, -0.9577, -0.9577, -0.9577,  0.5514,  0.5514,
          0.5514,  0.5514,  0.5514,  0.5514,  0.5514,  0.5514,  0.5514,  0.5514,
          0.8342,  0.8342,  0.8342,  0.8342,  0.8342,  0.8342,  0.8342,  0.8342,
          0.8342,  0.8342,  0.9200,  0.9200,  0.9200,  0.9200,  0.9200,  0.9200,
          0.9200,  0.9200,  0.9200,  0.9200,  0.3919,  0.3919,  0.3919,  0.3919,
          0.3919,  0.3919,  0.3919,  0.3919,  0.3919,  0.3919,  0.7210,  0.7210,
          0.7210,  0.7210,  0.7210,  0.7210,  0.7210,  0.7210,  0.7210,  0.7210,
         -0.6929, -0.6929, -0.6929, -0.6929, -0.6929, -0.6929, -0.6929, -0.6929,
         -0.6929, -0.6929, -0.9992, -0.9992, -0.9992, -0.9992, -0.9992, -0.9992,
         -0.9992, -0.9992, -0.9992, -0.9992, -0.0398, -0.0398, -0.0398, -0.0398,
         -0.0398, -0.0398, -0.0398, -0.0398, -0.0398, -0.0398,  0.0795,  0.0795,
          0.0795,  0.0795,  0.0795,  0.0795,  0.0795,  0.0795,  0.0795,  0.0795,
         -0.9968, -0.9968, -0.9968, -0.9968, -0.9968, -0.9968, -0.9968, -0.9968,
         -0.9968, -0.9968, -0.1585, -0.1585, -0.1585, -0.1585, -0.1585, -0.1585,
         -0.1585, -0.1585, -0.1585, -0.1585,  0.9874,  0.9874,  0.9874,  0.9874,
          0.9874,  0.9874,  0.9874,  0.9874,  0.9874,  0.9874, -0.3131, -0.3131,
         -0.3131, -0.3131, -0.3131, -0.3131, -0.3131, -0.3131, -0.3131, -0.3131,
          0.9497,  0.9497,  0.9497,  0.9497,  0.9497,  0.9497,  0.9497,  0.9497,
          0.9497,  0.9497, -0.5946, -0.5946, -0.5946, -0.5946, -0.5946, -0.5946,
         -0.5946, -0.5946, -0.5946, -0.5946,  0.8040,  0.8040,  0.8040,  0.8040,
          0.8040,  0.8040,  0.8040,  0.8040,  0.8040,  0.8040, -0.9562, -0.9562,
         -0.9562, -0.9562, -0.9562, -0.9562, -0.9562, -0.9562, -0.9562, -0.9562,
          0.2928,  0.2928,  0.2928,  0.2928,  0.2928,  0.2928,  0.2928,  0.2928,
          0.2928,  0.2928, -0.5599, -0.5599, -0.5599, -0.5599, -0.5599, -0.5599,
         -0.5599, -0.5599, -0.5599, -0.5599, -0.8285, -0.8285, -0.8285, -0.8285,
         -0.8285, -0.8285, -0.8285, -0.8285, -0.8285, -0.8285,  0.9279,  0.9279,
          0.9279,  0.9279,  0.9279,  0.9279,  0.9279,  0.9279,  0.9279,  0.9279,
          0.3729,  0.3729,  0.3729,  0.3729,  0.3729,  0.3729,  0.3729,  0.3729,
          0.3729,  0.3729,  0.6921,  0.6921,  0.6921,  0.6921,  0.6921,  0.6921,
          0.6921,  0.6921,  0.6921,  0.6921, -0.7218, -0.7218, -0.7218, -0.7218,
         -0.7218, -0.7218, -0.7218, -0.7218, -0.7218, -0.7218, -0.9991, -0.9991,
         -0.9991, -0.9991, -0.9991, -0.9991, -0.9991, -0.9991, -0.9991, -0.9991,
          0.0421,  0.0421,  0.0421,  0.0421,  0.0421,  0.0421,  0.0421,  0.0421,
          0.0421,  0.0421, -0.0841, -0.0841, -0.0841, -0.0841, -0.0841, -0.0841,
         -0.0841, -0.0841, -0.0841, -0.0841, -0.9965, -0.9965, -0.9965, -0.9965,
         -0.9965, -0.9965, -0.9965, -0.9965, -0.9965, -0.9965,  0.1676,  0.1676,
          0.1676,  0.1676,  0.1676,  0.1676,  0.1676,  0.1676,  0.1676,  0.1676,
          0.9859,  0.9859,  0.9859,  0.9859,  0.9859,  0.9859,  0.9859,  0.9859,
          0.9859,  0.9859]])
"""